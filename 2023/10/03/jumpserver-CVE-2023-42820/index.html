<!DOCTYPE html>
<html>
  <head>
<meta name="referrer" content="never">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CNTF3L2LQC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CNTF3L2LQC');
</script>  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?a2d27f70a2f1f5f5edfb5884096627ae";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script> 
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    
    <title>
      图片验证码引起的惨案 一个开源验证码库导致的 jumpserver 账户接管漏洞 - 白帽酱の博客
    </title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
    
<link rel="stylesheet" href="/style/style.css">

  <meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="白帽酱の博客" type="application/atom+xml">
</head>
  <body>
    <canvas id='pagemap'></canvas>
    
    <div id="post-toc" class="animated hiddenToc hide">
      <span class="title">Toc</span>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E5%BA%93%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-text">验证码库中的一个问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E7%BD%AE%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-text">重置用户密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0EXP"><span class="toc-text">构造EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96EXP"><span class="toc-text">自动化EXP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-text">漏洞修复</span></a></li></ol>
    </div>
    
    <div id="fixed-menu-wrap">
      <span class="iconfont icon-sousuo search-box menu-reset"></span>
      <span class="icon-toc menu-reset">Toc</span>
      <span class="iconfont icon-arrowup menu-reset"></span>
    </div>
    <div id="fixed-menu">
      <span class="iconfont icon-menu-"></span>
    </div>
    <div id="progress">
      <div class="line"></div>
    </div>
    <div id="search-shade" class="animated hiddenSearch hide">
      <div class="input-wrap">
        <span class="iconfont icon-sousuo search-box"></span>
        <input type="text" placeholder="Search" />
        <span class="iconfont icon-close"></span>
      </div>
      <div class="search-result">
        <div class="meta">
          <span><b id="result-count">0</b> results found</span>
          <img src="/images/logo.jpeg" />
        </div>
        <ul id="result-box"></ul>
      </div>
    </div>
    <div id="menu-mask" class="animated hideMenuMask hide">
      <span class="iconfont icon-close"></span>
      <div class="nav">
        
        <a href="/" class="">
          首页
        </a>
        
        <a href="/archives" class="">
          归档
        </a>
        
        <a href="/categories" class="">
          分类
        </a>
        
        <a href="/tags" class="">
          标签
        </a>
        
        <a href="/friends" class="">
          友链
        </a>
        
        <a href="/about" class="">
          关于
        </a>
        
      </div>
    </div>
    <div id="header">
      <div class="intro">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        <div class="author">白帽酱</div>
      </div>
      <div class="nav">
        <span class="iconfont icon-menu menu-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
    </div>
    <div id="side" class="animated bounceInLeft">
      <div class="shrink">
        <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        <span class="iconfont icon-menu toggle-icon"></span>
        <a href="#" class="search-box">
          <span class="iconfont icon-sousuo"></span>
        </a>
      </div>
      <div class="magnify">
        <div class="about">
          <div class="author">白帽酱</div>
          <a href="/" class="logo" style="background-image: url('/images/logo.jpeg')"></a>
        </div>

        <div class="nav">
          
          <a href="/" class="">
            首页
          </a>
          
          <a href="/archives" class="">
            归档
          </a>
          
          <a href="/categories" class="">
            分类
          </a>
          
          <a href="/tags" class="">
            标签
          </a>
          
          <a href="/friends" class="">
            友链
          </a>
          
          <a href="/about" class="">
            关于
          </a>
          
          <a href="#" class="search-box">
            <span class="iconfont icon-sousuo"></span>
          </a>
        </div>
        <div class="bottom">
          <div class="follow">
            
            <a href="https://github.com/burpheart" target="_block">
              <span class="iconfont icon-github"></span>
            </a>
            
            <a href="https://twitter.com/burp_heart" target="_block">
              <span class="iconfont icon-twitter"></span>
            </a>
            
            <a href="https://space.bilibili.com/32890488" target="_block">
              <span class="iconfont icon-bilibili"></span>
            </a>
             
            <a href="/atom.xml" target="_block">
              <span class="iconfont icon-rss"></span>
            </a>
            
          </div>
        </div>
      </div>
    </div>
    <div id="container">
      <div class="main animated bounceInRight delay-0.7s">
        <article class="post-entry">
    <div class="header">
      
      <div class="title">图片验证码引起的惨案 一个开源验证码库导致的 jumpserver 账户接管漏洞</div>
      <div class="meta">
        <span class="item">
          <span class="iconfont icon-time-circle"></span>
          <span>2023/10/03</span>
        </span>

        

         
        <span class="item">
          <span class="iconfont icon-folder"></span>
          <span>
              
                
                  <a href="/categories/漏洞分析">漏洞分析</a>
                
              
                
                  <a href="/categories/web">web</a>
                
              
                
                  <a href="/categories/EXP">EXP</a>
                
              
          </span>
        </span>
        
        
         
          <span class="item">
            <span class="iconfont icon-tag1"></span>
            <span>
                
                  
                    <a href="/tags/CVE-2023-42820">CVE-2023-42820</a>
                  
                
                  
                    <a href="/tags/django-simple-captcha">django-simple-captcha</a>
                  
                
                  
                    <a href="/tags/django-simple-captcha vulnerability">django-simple-captcha vulnerability</a>
                  
                
            </span>
          </span>
         
      </div>
      <div>
      </div>
    </div>
    <html><head></head><body><h1 id="前言">前言<a class="post-anchor" href="#前言"></a></h1><p>jumpserver 前不久出了一个密码重置漏洞   <a target="_blank" rel="noopener" href="https://github.com/jumpserver/jumpserver/security/advisories/GHSA-7prv-g565-82qp">CVE-2023-42820</a><br>在当天我就复现了这个漏洞 这个随机数的案例非常有趣 这个漏洞出现在了一个很难想到的位置 是一个由第三方依赖库引起的问题</p>
<span id="more"></span>

<h1 id="漏洞分析">漏洞分析<a class="post-anchor" href="#漏洞分析"></a></h1><h2 id="验证码库中的一个问题">验证码库中的一个问题<a class="post-anchor" href="#验证码库中的一个问题"></a></h2><p>分析一下修复后的版本差异 发现了一个有趣的commit<br> 生成随机字符串的时候增加重置了随机数种子的步骤<br><a target="_blank" rel="noopener" href="https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac0">https://github.com/jumpserver/jumpserver/commit/ce645b1710c5821119f313e1b3d801470565aac0</a><br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696321191422-359141c4-3775-47ca-ac3d-f892c7acc1b1.png#averageHue=%23e8c589&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=490&amp;id=ndLaw&amp;originHeight=735&amp;originWidth=1977&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=75882&amp;status=done&amp;style=none&amp;taskId=uc5750001-a0b3-41a1-af40-4d503def57d&amp;title=&amp;width=1318" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696321191422-359141c4-3775-47ca-ac3d-f892c7acc1b1.png#averageHue=%23e8c589&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=490&amp;id=ndLaw&amp;originHeight=735&amp;originWidth=1977&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=75882&amp;status=done&amp;style=none&amp;taskId=uc5750001-a0b3-41a1-af40-4d503def57d&amp;title=&amp;width=1318" alt="图片.png"></a><br>我原本以为这个漏洞可能是 攻击者可以收集到足够随机数导致伪随机数预测的问题<br>但是我发现了同commit账号下的这个给第三方验证码库django-simple-captcha的PR<br><a target="_blank" rel="noopener" href="https://github.com/mbi/django-simple-captcha/pull/221">https://github.com/mbi/django-simple-captcha/pull/221</a><br>在这个pr里同样也有一处设置种子的步骤<br>继续审计 发现了这个验证码库的奇葩逻辑<br>下面是我画的一张django-simple-captcha 库的流程图<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/svg/25577536/1696308026077-8ea4ecc8-64e5-44b2-a00e-fb7bd715b223.svg#clientId=u9091d697-e841-4&amp;from=ui&amp;id=vIGhH&amp;originHeight=481&amp;originWidth=481&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=true&amp;size=19096&amp;status=done&amp;style=none&amp;taskId=uc1e6d1b7-50f3-4664-912e-4f75542c55e&amp;title=django-simple-captcha%20%E5%A4%A7%E8%87%B4%E9%AA%8C%E8%AF%81%E8%BF%87%E7%A8%8B" data-caption="django-simple-captcha 大致验证过程" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/svg/25577536/1696308026077-8ea4ecc8-64e5-44b2-a00e-fb7bd715b223.svg#clientId=u9091d697-e841-4&amp;from=ui&amp;id=vIGhH&amp;originHeight=481&amp;originWidth=481&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=true&amp;size=19096&amp;status=done&amp;style=none&amp;taskId=uc1e6d1b7-50f3-4664-912e-4f75542c55e&amp;title=django-simple-captcha%20%E5%A4%A7%E8%87%B4%E9%AA%8C%E8%AF%81%E8%BF%87%E7%A8%8B" alt="django-simple-captcha 大致验证过程"></a><br>完整的的验证码流程有3个请求<br>第一个请求 生成验证码<br> 服务器会生成随机challenge 和一个随机字符串key 储存到数据库  把包含key的验证码url返回<br>第二个请求 访问验证码url 获取 验证码图片/语音<br>服务器会将key 设置为随机数seed  之后根据key从数据库查找challenge  根据配置文件随机生成噪点和干扰线 渲染成验证码图片<br>第三个请求 验证验证码<br>之后服务器会根据key从数据库查找challenge 进行eval后与提交的答案比较 返回比较结果 </p>
<p><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696322126349-37c5ba25-650c-47e3-abf4-1e1e5121dca8.png#averageHue=%23f1f4f6&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=207&amp;id=ue797666e&amp;originHeight=310&amp;originWidth=845&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=24793&amp;status=done&amp;style=none&amp;taskId=u8e1741b1-2454-4588-9ab0-8f670efaa36&amp;title=&amp;width=563.3333333333334" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696322126349-37c5ba25-650c-47e3-abf4-1e1e5121dca8.png#averageHue=%23f1f4f6&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=207&amp;id=ue797666e&amp;originHeight=310&amp;originWidth=845&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=24793&amp;status=done&amp;style=none&amp;taskId=u8e1741b1-2454-4588-9ab0-8f670efaa36&amp;title=&amp;width=563.3333333333334" alt="图片.png"></a><br>在这里很容易看到一个不对劲的步骤<br>这个库居然把作为随机数seed 的key直接返回给用户 作为验证码的索引<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696321031771-6a20236e-5910-4916-8173-db18eab7655a.png#averageHue=%23fdfcfc&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=235&amp;id=uxLk0&amp;originHeight=353&amp;originWidth=982&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=23622&amp;status=done&amp;style=none&amp;taskId=u16731320-7605-4de8-b640-715a812dc56&amp;title=&amp;width=654.6666666666666" data-caption="c4d77bd05a44d87e79c1b0b1da4a374.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696321031771-6a20236e-5910-4916-8173-db18eab7655a.png#averageHue=%23fdfcfc&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=235&amp;id=uxLk0&amp;originHeight=353&amp;originWidth=982&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=23622&amp;status=done&amp;style=none&amp;taskId=u16731320-7605-4de8-b640-715a812dc56&amp;title=&amp;width=654.6666666666666" alt="c4d77bd05a44d87e79c1b0b1da4a374.png"></a><br>:::info<br> /captcha/image/{key}/<br>:::<br>也就是说访问一次验证码图片 当前进程的全局seed 就会被设置为key 同时我们也拿到了这个key<br>现在 我们就可以利用这个key预测之后生成的随机数</p>
<h2 id="重置用户密码">重置用户密码<a class="post-anchor" href="#重置用户密码"></a></h2><p>现在我们可以控制随机数的生成 那么怎么利用这个特性呢?<br>jumpserver的密码重置功能默认是开启的<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696322428722-94710ec3-6cbf-4190-baf6-4b6ffa632c2a.png#averageHue=%23d3d5cd&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=365&amp;id=u220db835&amp;originHeight=547&amp;originWidth=850&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=54062&amp;status=done&amp;style=none&amp;taskId=u4c8f0f4e-2b5b-438a-836d-3aa58104adb&amp;title=&amp;width=566.6666666666666" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696322428722-94710ec3-6cbf-4190-baf6-4b6ffa632c2a.png#averageHue=%23d3d5cd&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=365&amp;id=u220db835&amp;originHeight=547&amp;originWidth=850&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=54062&amp;status=done&amp;style=none&amp;taskId=u4c8f0f4e-2b5b-438a-836d-3aa58104adb&amp;title=&amp;width=566.6666666666666" alt="图片.png"></a><br>jumpserver重置验证码时会向邮箱发送包含随机字符串验证码的一封邮件 (因为代码上的问题  没有正确配置邮件服务器时也能正常生成验证码)<br>在这里我们可以通过拿到的key预测这个验证码</p>
<h2 id="构造EXP">构造EXP<a class="post-anchor" href="#构造EXP"></a></h2><p>在利用过程中 我们需要知道当设置种子后又生成了多少个随机数<br>分析验证码生成部分的代码 找到验证码生成的过程<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696322810887-5d42f6da-6a44-4716-aca7-03ee9d50f594.png#averageHue=%23fefdfc&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=185&amp;id=u15cfed11&amp;originHeight=278&amp;originWidth=735&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=17745&amp;status=done&amp;style=none&amp;taskId=udc0efc20-8c24-4e8b-9ce0-3420b3ea7f1&amp;title=&amp;width=490" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696322810887-5d42f6da-6a44-4716-aca7-03ee9d50f594.png#averageHue=%23fefdfc&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=185&amp;id=u15cfed11&amp;originHeight=278&amp;originWidth=735&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=17745&amp;status=done&amp;style=none&amp;taskId=udc0efc20-8c24-4e8b-9ce0-3420b3ea7f1&amp;title=&amp;width=490" alt="图片.png"></a><br>  把随机数生成的部分抽出 之后放入之后的EXP中<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323006394-23c25c01-2306-4b73-83fe-75b5b638f5f6.png#averageHue=%23fefcf9&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=391&amp;id=uf1c6e9fc&amp;originHeight=586&amp;originWidth=886&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=50213&amp;status=done&amp;style=none&amp;taskId=ufad3dbb8-76c4-4fd4-8733-d01ae66e68b&amp;title=&amp;width=590.6666666666666" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323006394-23c25c01-2306-4b73-83fe-75b5b638f5f6.png#averageHue=%23fefcf9&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=391&amp;id=uf1c6e9fc&amp;originHeight=586&amp;originWidth=886&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=50213&amp;status=done&amp;style=none&amp;taskId=ufad3dbb8-76c4-4fd4-8733-d01ae66e68b&amp;title=&amp;width=590.6666666666666" alt="图片.png"></a><br>这里有几点需要注意<br>在验证码字符的旋转过程 会导致随机数生成的次数变化 有一个随机数生成循环会随验证码的长度而变化<br>因为jumpserver使用的验证码类型为数学计算验证码 所以生成的验证码位数在 4-5位<br>另外出现在CAPTCHA_PUNCTUATION内的验证码字符不会当做单独的一个字符<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323448628-3e168dd2-aa37-4750-a7f8-5c95b3e19830.png#averageHue=%23dddfdd&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=25&amp;id=u732dd5b1&amp;originHeight=38&amp;originWidth=180&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=5540&amp;status=done&amp;style=none&amp;taskId=u2222a227-40e8-4978-93d1-811d78488e6&amp;title=&amp;width=120" data-caption="14bd11652d2286aded38f906687bcd1.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323448628-3e168dd2-aa37-4750-a7f8-5c95b3e19830.png#averageHue=%23dddfdd&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=25&amp;id=u732dd5b1&amp;originHeight=38&amp;originWidth=180&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=5540&amp;status=done&amp;style=none&amp;taskId=u2222a227-40e8-4978-93d1-811d78488e6&amp;title=&amp;width=120" alt="14bd11652d2286aded38f906687bcd1.png"></a><br>也就是说如果验证码为 5-1=时  5- 会被认为是一个字符<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323459094-585b1c65-cd0a-4d1b-b6ab-d819ba50ef8a.png#averageHue=%23faf9f7&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=19&amp;id=ucf9c7d53&amp;originHeight=29&amp;originWidth=381&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=1808&amp;status=done&amp;style=none&amp;taskId=ud70ce228-8c1b-4f7b-a30f-6475ffc6891&amp;title=&amp;width=254" data-caption="a29a9b6018d4ffd0938c83fa1326c46.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323459094-585b1c65-cd0a-4d1b-b6ab-d819ba50ef8a.png#averageHue=%23faf9f7&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=19&amp;id=ucf9c7d53&amp;originHeight=29&amp;originWidth=381&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=1808&amp;status=done&amp;style=none&amp;taskId=ud70ce228-8c1b-4f7b-a30f-6475ffc6891&amp;title=&amp;width=254" alt="a29a9b6018d4ffd0938c83fa1326c46.png"></a><br>所以 实际上循环范围应该是3-5<br>之后按照jumpserver中的实现生成验证码字符串</p>
<p><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323769401-bc1c0c4c-ff7a-40cd-8443-84e0ce11e72a.png#averageHue=%23fefefe&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=338&amp;id=uec2d82be&amp;originHeight=507&amp;originWidth=782&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=24330&amp;status=done&amp;style=none&amp;taskId=u94fde76e-0710-4a5d-b256-66ae33e3a27&amp;title=&amp;width=521.3333333333334" data-caption="图片.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323769401-bc1c0c4c-ff7a-40cd-8443-84e0ce11e72a.png#averageHue=%23fefefe&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=338&amp;id=uec2d82be&amp;originHeight=507&amp;originWidth=782&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=24330&amp;status=done&amp;style=none&amp;taskId=u94fde76e-0710-4a5d-b256-66ae33e3a27&amp;title=&amp;width=521.3333333333334" alt="图片.png"></a><br>成功重置了密码<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323544901-b06e1ee7-ba5d-414e-9185-26ecec70caeb.png#averageHue=%235fa8b4&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=737&amp;id=u6714c621&amp;originHeight=1106&amp;originWidth=1962&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=70242&amp;status=done&amp;style=none&amp;taskId=ufc5c8a5a-9933-4186-b2e4-4b17c17aa28&amp;title=&amp;width=1308" data-caption="519af89153fec094205174d84aede7d.png" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/png/25577536/1696323544901-b06e1ee7-ba5d-414e-9185-26ecec70caeb.png#averageHue=%235fa8b4&amp;clientId=u97ca79c8-1446-4&amp;from=paste&amp;height=737&amp;id=u6714c621&amp;originHeight=1106&amp;originWidth=1962&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=70242&amp;status=done&amp;style=none&amp;taskId=ufc5c8a5a-9933-4186-b2e4-4b17c17aa28&amp;title=&amp;width=1308" alt="519af89153fec094205174d84aede7d.png"></a></p>
<h2 id="自动化EXP">自动化EXP<a class="post-anchor" href="#自动化EXP"></a></h2><p>手工利用这个漏洞还是有点麻烦 所以我们要实现一个自动化利用的exp<br>EXP暂时不公开<br>这里就交给读者自己实现EXP了 内容涉及CSRF 和 表单处理的内容 自己实现一遍应该会学到很多<br>下面给出一点点提示<br>自动化利用我们得绕过图片验证码<br>在重置密码的时候需要完成一个图片验证码<br> 我们通过之前的漏洞来固定seed 时生成的图片验证码也可预测<br>(这一步中的随机数生成次数与之前的有些差异 通过调试分析代码可以简单解决)</p>
<p>最终 我实现了一个高成功率的自动化利用脚本 可以在3s内完成 包括图片验证码绕过的 自动密码重置脚本<br><a target="_blank" rel="noopener" href="https://cdn.nlark.com/yuque/0/2023/gif/25577536/1696324729721-78f98569-f86f-45b0-9831-0d2e6bc1383e.gif#averageHue=%2338b997&amp;clientId=u97ca79c8-1446-4&amp;from=ui&amp;id=FVuCg&amp;originHeight=720&amp;originWidth=1280&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=814471&amp;status=done&amp;style=none&amp;taskId=ua9b0deb9-1c18-401a-af33-2b72b42dca8&amp;title=" data-caption="1.gif" data-fancybox="images"><img src="https://cdn.nlark.com/yuque/0/2023/gif/25577536/1696324729721-78f98569-f86f-45b0-9831-0d2e6bc1383e.gif#averageHue=%2338b997&amp;clientId=u97ca79c8-1446-4&amp;from=ui&amp;id=FVuCg&amp;originHeight=720&amp;originWidth=1280&amp;originalType=binary&amp;ratio=1.5&amp;rotation=0&amp;showTitle=false&amp;size=814471&amp;status=done&amp;style=none&amp;taskId=ua9b0deb9-1c18-401a-af33-2b72b42dca8&amp;title=" alt="1.gif"></a><br>详细步骤:</p>
<ol>
<li>进入重置密码流程</li>
<li>访问 /core/auth/password/forget/previewing/ 生成图片验证码url1</li>
<li>多次访问验证码url1  让seed污染大部分的 workers 提高成功概率 让seed固定</li>
<li>访问 /core/auth/password/forget/previewing/ 生成新图片验证码url2</li>
<li>根据seed 预测图片验证码 解决验证码</li>
<li>多次访问验证码url1   让seed污染大部分的 workers 提高成功概率 让seed固定</li>
<li>发送邮箱验证码</li>
<li>根据seed 预测验证码 尝试验证 获取重置链接</li>
<li> 重置密码</li>
</ol>
<h1 id="漏洞修复">漏洞修复<a class="post-anchor" href="#漏洞修复"></a></h1><p>django-simple-captcha 发布了 0.5.19版本 通过重置种子 修复了这个问题<br><a target="_blank" rel="noopener" href="https://github.com/mbi/django-simple-captcha/blob/master/CHANGES">https://github.com/mbi/django-simple-captcha/blob/master/CHANGES</a><br>jumpserver &gt;= v2.28.19, &gt;= v3.6.5 临时修复了这个问题<br><a target="_blank" rel="noopener" href="https://github.com/jumpserver/jumpserver/security/advisories/GHSA-7prv-g565-82qp">https://github.com/jumpserver/jumpserver/security/advisories/GHSA-7prv-g565-82qp</a></p>
<p>django-simple-captcha vulnerability</p>
</body></html>

  
  <div class="post-guide">
    <div class="item left">
        
          <a href="/2024/11/09/Java-Code-Decryption-Using-Frida-Restoring-JVMTI-Agent-Encrypted-Classes-Using-Frida-in-Linux/">Java 代码解密：使用 Frida 还原 JVMTI Agent 加密保护的java类 & Linux 环境下的Frida 使用</a>
        
    </div>
    <div class="item right">
        
          <a href="/2023/08/19/Jetty-Customize-memory-webshell/">一种在高版本JDK下 的新型嵌入式Jetty Customizer内存马实现</a>
        
    </div>
  </div>

  

  <div class="post-copyright">
    <div class="auth">
      本文作者：<a href="https://rce.moe">白帽酱</a>
    </div>
    <div class="link">
      永久链接：<a href="https://rce.moe/2023/10/03/jumpserver-CVE-2023-42820/">https://rce.moe/2023/10/03/jumpserver-CVE-2023-42820/</a>
    </div>
    <div class="declare">
      版权声明：本文首发于<a href="https://rce.moe">白帽酱</a>的博客，转载请注明出处！
    </div>
  </div>

  <div id="comment"></div>

  
  
</article>
<!--<div id="gitalk-container"></div>-->
<!--<link rel="stylesheet" href="https://unpkg.com/gitalk@latest/dist/gitalk.css">-->
<!--<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>-->
<!--<script src="https://priesttomb.github.io/js/md5.min.js"></script>-->
<!--
<script type="text/javascript">
    new Gitalk({
        clientID: '1488ae49eda310270a91',
        clientSecret: '83e505f36d0351b0ef1a225d089546cb40ecd31a',
        repo: 'hexoblog',
        owner: 'burpheart',
        admin: 'burpheart',
        id: md5(location.pathname),
        distractionFreeMode: true,
        proxy: 'https://servelesscors.rce.moe/api/cors?url=https://github.com/login/oauth/access_token'
    }).render('gitalk-container')
-->
<div id="tcomment"></div>
<script src="https://cdn.jsdelivr.net/npm/twikoo@1.6.41/dist/twikoo.all.min.js"></script>
<script>
twikoo.init({
  envId: 'https://twikoo.rce.moe', // 腾讯云环境填 envId；Vercel 环境填地址（https://xxx.vercel.app）
  el: '#tcomment', // 容器元素
  // region: 'ap-guangzhou', // 环境地域，默认为 ap-shanghai，腾讯云环境填 ap-shanghai 或 ap-guangzhou；Vercel 环境不填
  // path: location.pathname, // 用于区分不同文章的自定义 js 路径，如果您的文章路径不是 location.pathname，需传此参数
  // lang: 'zh-CN', // 用于手动设定评论区语言，支持的语言列表 https://github.com/twikoojs/twikoo/blob/main/src/client/utils/i18n/index.js
})
</script>
</script>
        <footer>
          <div class="copyright">
            ©2025
            <a href="https://rce.moe">白帽酱</a> Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a> |
            <a target="_blank" rel="noopener" href="https://github.com/shixiaohu2206/hexo-theme-huhu">hexo-theme-huhu</a>
          </div>
          
        </footer>
      </div>
    </div>
  </body>
  
</html>
<script type="text/javascript">
                  window.HUHU_CONFIG = JSON.parse("{\"share\":[\"weibo\",\"weixin\",\"qqkongjian\",\"QQ\",\"douban\",\"facebook\",\"twitter\",\"google\"],\"service_worker\":{\"open\":false}}")
                </script> <script type="text/javascript">window.addEventListener('load', function() {
    
    window.loadJs = function(d, m, a) {
      var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement
      var b = document.createElement('script')
      b.defer = true
      b.setAttribute('type', 'text/javascript')
      b.setAttribute('charset', 'UTF-8')
      b.setAttribute('async', 'true')
      b.setAttribute('src', d)
      m && b.setAttribute('data-main', '/scripts/app-built')
      if (typeof a === 'function') {
        if (window.attachEvent) {
          b.onreadystatechange = function() {
            var e = b.readyState
            if (e === 'loaded' || e === 'complete') {
              b.onreadystatechange = null
              a()
            }
          }
        } else {
          b.onload = a
        }
      }
      c.appendChild(b)
    }
    window.loadJs && window.loadJs('https://cdn.bootcss.com/require.js/2.3.6/require.min.js', true, function() {require.config({"paths":{"util":"util","share":"share","search":"search","pagemap":"pagemap.min","registerSW":"registerSW","valine":"cdn/Valine.min","av":["https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min"],"pjax":["https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min"],"jquery":["https://cdn.bootcss.com/jquery/3.4.1/jquery.min"],"confirm":["https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min"],"fancybox":["https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min"],"chart":["https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.bundle.min"]},"map":{"*":{"css":"https://cdn.bootcss.com/require-css/0.1.10/css.min.js"}},"shim":{"fancybox":{"deps":["css!https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css"]},"confirm":{"deps":["css!https://cdn.bootcss.com/jquery-confirm/3.3.4/jquery-confirm.min.css"]},"chart":{"deps":["css!https://cdn.bootcss.com/Chart.js/2.8.0-rc.1/Chart.min.css"]}},"waitSeconds":3})})
  })</script> <script type="text/javascript">
                  ;(function() {
                    var bp = document.createElement('script')
                    var curProtocol = window.location.protocol.split(':')[0]
                    if (curProtocol === 'https') {
                      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'
                    } else {
                      bp.src = 'http://push.zhanzhang.baidu.com/push.js'
                    }
                    var s = document.getElementsByTagName('script')[0]
                    s.parentNode.insertBefore(bp, s)
                  })()
                </script> 
